<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Building an Automated LLM Scoring Service: From Prototype to Production — Humza Tareen</title>
  <meta name="description" content="How I built and hardened an automated rating service that scores LLM outputs. From idempotent Cloud Tasks to LiteLLM proxy, Redis state management, and VPC networking battles.">
  <meta name="author" content="Humza Tareen">
  <meta name="keywords" content="LLM, Auto-Rating, Cloud Run, Cloud Tasks, Redis, LiteLLM, PostgreSQL, Python, FastAPI">
  <link rel="canonical" href="https://humzakt.github.io/blog/auto-rater-service-llm-scoring.html">
  <meta property="og:title" content="Building an Automated LLM Scoring Service: From Prototype to Production">
  <meta property="og:description" content="How I built and hardened an automated rating service that scores LLM outputs. From idempotent Cloud Tasks to LiteLLM proxy, Redis state management, and VPC networking battles.">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://humzakt.github.io/blog/auto-rater-service-llm-scoring.html">
  <meta property="og:image" content="https://humzakt.github.io/suit-blue-bg.jpg">
  <meta property="og:site_name" content="Humza Tareen">
  <meta property="article:published_time" content="2026-02-08T00:00:00Z">
  <meta property="article:author" content="Humza Tareen">
  <meta property="article:tag" content="Cloud Run">
  <meta property="article:tag" content="Cloud Tasks">
  <meta property="article:tag" content="Redis">
  <meta property="article:tag" content="LiteLLM">
  <meta property="article:tag" content="Python">
  <meta property="article:tag" content="FastAPI">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Building an Automated LLM Scoring Service: From Prototype to Production">
  <meta name="twitter:description" content="Idempotent Cloud Tasks, LiteLLM proxy, Redis state management, and VPC networking battles.">
  <meta name="twitter:image" content="https://humzakt.github.io/suit-blue-bg.jpg">
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "Building an Automated LLM Scoring Service: From Prototype to Production",
    "description": "How I built and hardened an automated rating service that scores LLM outputs.",
    "image": "https://humzakt.github.io/suit-blue-bg.jpg",
    "author": { "@type": "Person", "name": "Humza Tareen", "url": "https://humzakt.github.io" },
    "publisher": { "@type": "Person", "name": "Humza Tareen" },
    "datePublished": "2026-02-08",
    "dateModified": "2026-02-08",
    "mainEntityOfPage": { "@type": "WebPage", "@id": "https://humzakt.github.io/blog/auto-rater-service-llm-scoring.html" },
    "keywords": ["Cloud Run", "Cloud Tasks", "Redis", "LiteLLM", "Python", "FastAPI"],
    "articleSection": "AI Infrastructure"
  }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
  <link rel="stylesheet" href="../styles.css">
  <link rel="alternate" type="application/rss+xml" title="Humza Tareen Blog" href="https://humzakt.github.io/blog/feed.xml">
  <style>
    .blog-post { max-width: 800px; margin: 0 auto; padding: calc(var(--nav-height) + 40px) 24px 80px; }
    .blog-back { display: inline-flex; align-items: center; gap: 8px; color: var(--accent); font-family: var(--font-mono); font-size: 14px; margin-bottom: 32px; }
    .blog-back:hover { gap: 12px; }
    .blog-header { margin-bottom: 40px; }
    .blog-title { font-size: clamp(28px, 5vw, 42px); color: var(--heading); line-height: 1.2; margin-bottom: 16px; font-weight: 700; }
    .blog-meta { display: flex; flex-wrap: wrap; align-items: center; gap: 16px; color: var(--text); font-size: 14px; font-family: var(--font-mono); margin-bottom: 24px; }
    .blog-meta time { color: var(--accent); }
    .blog-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 24px; }
    .blog-tag { font-size: 12px; padding: 4px 12px; border-radius: 20px; background: rgba(100,255,218,0.08); color: var(--accent); font-family: var(--font-mono); }
    .blog-content { color: var(--text-light); line-height: 1.8; font-size: 17px; }
    .blog-content h2 { color: var(--heading); font-size: 24px; margin: 48px 0 16px; font-weight: 600; }
    .blog-content h3 { color: var(--heading); font-size: 20px; margin: 32px 0 12px; font-weight: 600; }
    .blog-content p { margin-bottom: 20px; }
    .blog-content ul, .blog-content ol { margin-bottom: 20px; padding-left: 24px; }
    .blog-content li { margin-bottom: 8px; }
    .blog-content strong { color: var(--heading); font-weight: 600; }
    .blog-content code { font-family: var(--font-mono); font-size: 0.9em; background: var(--bg-light); padding: 2px 6px; border-radius: 4px; color: var(--accent); }
    .blog-content pre { background: var(--bg-light); border: 1px solid var(--card-border); border-radius: 8px; padding: 20px; overflow-x: auto; margin-bottom: 24px; font-size: 14px; line-height: 1.6; }
    .blog-content pre code { background: none; padding: 0; color: var(--text-light); }
    .blog-content a { color: var(--accent); text-decoration: underline; text-underline-offset: 3px; }
    .blog-content a:hover { color: var(--heading); }
    .blog-content table { width: 100%; border-collapse: collapse; margin-bottom: 24px; font-size: 15px; }
    .blog-content th, .blog-content td { padding: 12px 16px; border: 1px solid var(--card-border); text-align: left; }
    .blog-content th { background: var(--bg-light); color: var(--heading); font-weight: 600; }
    .blog-footer { margin-top: 60px; padding-top: 32px; border-top: 1px solid var(--card-border); }
    .blog-author { display: flex; align-items: center; gap: 16px; }
    .blog-author-img { width: 56px; height: 56px; border-radius: 50%; object-fit: cover; }
    .blog-author-info h4 { color: var(--heading); font-size: 16px; }
    .blog-author-info p { color: var(--text); font-size: 14px; }
    .blog-cta { margin-top: 32px; text-align: center; }
    .blog-cta a { display: inline-block; padding: 12px 28px; border: 1px solid var(--accent); color: var(--accent); border-radius: 6px; font-family: var(--font-mono); font-size: 14px; transition: var(--transition); }
    .blog-cta a:hover { background: var(--accent-muted); }
    @media (max-width: 768px) { .blog-post { padding-top: calc(var(--nav-height) + 20px); } .blog-content { font-size: 16px; } }
  </style>
</head>
<body>
  <nav class="nav" id="nav" aria-label="Main navigation">
    <a href="../index.html" class="nav-logo" aria-label="Humza Tareen - Home">HT</a>
    <div class="nav-links" role="list">
      <div class="page-switcher"><a href="../engineering.html">Engineering</a><a href="../research.html">Research</a></div>
      <a href="../engineering.html#articles" role="listitem">All Articles</a>
      <a href="../engineering.html#contact" class="nav-cta" role="listitem">Hire Me</a>
    </div>
  </nav>
  <main class="blog-post">
    <a href="../engineering.html#articles" class="blog-back"><i class="fas fa-arrow-left"></i> All Articles</a>
    <article>
      <header class="blog-header">
        <h1 class="blog-title">Building an Automated LLM Scoring Service: From Prototype to Production</h1>
        <div class="blog-meta"><time datetime="2026-02-08">Feb 8, 2026</time><span>&middot;</span><span>10 min read</span><span>&middot;</span><span>Humza Tareen</span></div>
        <div class="blog-tags">
          <span class="blog-tag">Cloud Run</span><span class="blog-tag">Cloud Tasks</span><span class="blog-tag">Redis</span><span class="blog-tag">LiteLLM</span><span class="blog-tag">Python</span><span class="blog-tag">FastAPI</span>
        </div>
      </header>
      <div class="blog-content">
        <p>When an AI agent writes code, someone has to judge whether it's good. In our platform, that "someone" is often another LLM. The Auto-Rater takes an agent's output, runs it through evaluation strategies (direct scoring, chain-of-thought analysis, multi-model debate), and produces structured quality assessments. I took this service from a fragile prototype to a production system that handles thousands of evaluations daily.</p>
        
        <h2>The v1 Reality Check</h2>
        <p>The prototype worked, but production exposed its fragility. Hardcoded model names meant changing a model broke the whole service. No idempotency meant Cloud Tasks retries created duplicate evaluations. <code>print()</code> statements everywhere were invisible in Cloud Run's structured logging. The Redis client had no timeouts, so connection loss meant hangs forever. The database pool was sized for a laptop, not production load.</p>
        <p>v1 was a proof of concept. v2 needed to be production-ready.</p>
        
        <h2>Making Cloud Tasks Idempotent</h2>
        <p>The most impactful change. Cloud Tasks delivers at-least-once, meaning your handler <em>will</em> get called multiple times. Without idempotency, every retry creates a duplicate evaluation.</p>
        <p>The fix: deterministic UUIDs generated from the payload hash, with <code>INSERT ... ON CONFLICT DO NOTHING</code>:</p>
        <pre><code>import hashlib
import uuid

def generate_evaluation_id(payload: dict) -> str:
    """Deterministic ID from payload hash."""
    payload_str = json.dumps(payload, sort_keys=True)
    payload_hash = hashlib.sha256(payload_str.encode()).hexdigest()[:16]
    return str(uuid.UUID(payload_hash))

async def create_evaluation(payload: dict):
    eval_id = generate_evaluation_id(payload)
    
    # Idempotent insert - if ID exists, do nothing
    await db.execute(
        """
        INSERT INTO evaluations (id, payload, status)
        VALUES (:id, :payload, 'pending')
        ON CONFLICT (id) DO NOTHING
        """,
        {"id": eval_id, "payload": json.dumps(payload)}
    )</code></pre>
        <p>Zero duplicates since deployment. The same payload always generates the same ID, so retries are harmless.</p>
        
        <h2>The Logging Overhaul</h2>
        <p>Replacing <code>print()</code> with structured logging sounds simple. In practice, it meant replacing every logging call, adding env-driven config (different log levels per environment), correlation IDs via <code>X-Correlation-ID</code> header, cross-service correlation (trace a request from API → auto-rater → notification service), and PII stripping.</p>
        <p>Structured logs look like this:</p>
        <pre><code>{
  "timestamp": "2026-02-08T10:23:45Z",
  "level": "INFO",
  "service": "auto-rater",
  "correlation_id": "req-abc123",
  "evaluation_id": "eval-xyz789",
  "message": "Starting chain-of-thought scoring",
  "model": "gpt-4o",
  "strategy": "cot"
}</code></pre>
        <p>Now we can trace a request across services, filter by evaluation ID, and search logs by correlation ID. Debugging production issues went from "search for a string" to "query structured data."</p>
        
        <h2>Model-Agnostic Scoring with LiteLLM</h2>
        <p>The OpenAI-compatible responses envelope with LiteLLM pass-through. Any model available through LiteLLM works without code changes. Want to switch from GPT-4o to Claude Sonnet for scoring? Change one config value.</p>
        <pre><code># Before - hardcoded
response = openai.ChatCompletion.create(
    model="gpt-4",
    messages=[...]
)

# After - configurable via LiteLLM
response = litellm.completion(
    model=os.getenv("SCORING_MODEL", "gpt-4o"),
    messages=[...]
)</code></pre>
        <p>LiteLLM handles the differences between providers (OpenAI, Anthropic, Google) behind a unified interface. The service is now model-agnostic — swap models without touching code.</p>
        
        <h2>The VPC Networking Saga</h2>
        <p>A 3-day debugging journey. Cloud Run couldn't connect to Redis (Memorystore). Added socket timeouts (without them, connections hang forever). Added VPC connector. Then discovered Direct VPC Egress was conflicting with the connector — Cloud Run has two mutually exclusive VPC networking modes and the error message doesn't tell you that.</p>
        <p>Fix: removed VPC connector since infrastructure had already moved to Direct VPC Egress. The lesson: Cloud Run networking is subtle. When something doesn't work, check if you're mixing modes.</p>
        
        <h2>Redis State Recovery</h2>
        <p>Evaluations take 1-30 minutes. The frontend polls Redis for progress. Discovered state updates were logging "success" even when the Redis key didn't exist — <code>HSET</code> returns 0 for "field updated" and 0 for "key doesn't exist", so we couldn't distinguish success from failure.</p>
        <p>Rewrote state management to verify return values and create recovery records for lost state. Now, if Redis state disappears (expiration, eviction, crash), we can reconstruct it from recovery records.</p>
        
        <h2>Production Tuning</h2>
        <p>Cloud Run defaults to 80 concurrent requests per container. Each request holds a database connection. 80 × 10 instances = 800 connections against Cloud SQL supporting ~100. The fix:</p>
        <pre><code># Cloud Run service config
containerConcurrency: 10

# Uvicorn config
uvicorn.workers: 1

# SQLAlchemy pool config
pool_size: 5
max_overflow: 10</code></pre>
        <p>Now: 10 concurrent × 10 instances × 5 pool = 500 max connections, well under the limit. The trade-off: lower concurrency means more instances, but database stability is worth it.</p>
      </div>
      <footer class="blog-footer">
        <div class="blog-author"><img src="../suit-blue-bg.jpg" alt="Humza Tareen" class="blog-author-img"><div class="blog-author-info"><h4>Humza Tareen</h4><p>AI Engineer building production systems at scale. <a href="../engineering.html">View full portfolio</a></p></div></div>
        <div class="blog-cta"><a href="../engineering.html#articles">Read More Articles</a></div>
      </footer>
    </article>
  </main>
</body>
</html>
