<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Building a RAG Retrieval Service: pgvector, Embedding Migrations, and Provenance Tracking — Humza Tareen</title>
  <meta name="description" content="How I built a RAG retrieval service using pgvector, migrated embedding models under pressure, and added provenance tracking for evaluation calibration.">
  <meta name="author" content="Humza Tareen">
  <meta name="keywords" content="RAG, pgvector, Embeddings, PostgreSQL, Vector Search, Python, FastAPI, OpenAI">
  <link rel="canonical" href="https://humzakt.github.io/blog/rag-service-embedding-search.html">
  <link rel="author" href="https://humzakt.github.io/llms.txt" type="text/plain" title="LLMs.txt">
  <meta property="og:title" content="Building a RAG Retrieval Service: pgvector, Embedding Migrations, and Provenance Tracking">
  <meta property="og:description" content="How I built a RAG retrieval service using pgvector, migrated embedding models under pressure, and added provenance tracking for evaluation calibration.">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://humzakt.github.io/blog/rag-service-embedding-search.html">
  <meta property="og:image" content="https://humzakt.github.io/suit-blue-bg.jpg">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:site_name" content="Humza Tareen">
  <meta property="article:published_time" content="2026-02-08T00:00:00Z">
  <meta property="article:author" content="Humza Tareen">
  <meta property="article:tag" content="RAG">
  <meta property="article:tag" content="pgvector">
  <meta property="article:tag" content="Embeddings">
  <meta property="article:tag" content="PostgreSQL">
  <meta property="article:tag" content="FastAPI">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Building a RAG Retrieval Service: pgvector, Embedding Migrations, and Provenance Tracking">
  <meta name="twitter:description" content="How I built a RAG retrieval service using pgvector, migrated embedding models under pressure, and added provenance tracking.">
  <meta name="twitter:image" content="https://humzakt.github.io/suit-blue-bg.jpg">
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "Building a RAG Retrieval Service: pgvector, Embedding Migrations, and Provenance Tracking",
    "description": "How I built a RAG retrieval service using pgvector, migrated embedding models under pressure, and added provenance tracking for evaluation calibration.",
    "image": "https://humzakt.github.io/suit-blue-bg.jpg",
    "author": { "@type": "Person", "name": "Humza Tareen", "url": "https://humzakt.github.io" },
    "publisher": { "@type": "Person", "name": "Humza Tareen" },
    "datePublished": "2026-02-08",
    "dateModified": "2026-02-08",
    "mainEntityOfPage": { "@type": "WebPage", "@id": "https://humzakt.github.io/blog/rag-service-embedding-search.html" },
    "keywords": ["RAG", "pgvector", "Embeddings", "PostgreSQL", "Vector Search", "Python", "FastAPI", "OpenAI"],
    "articleSection": "AI/ML Infrastructure"
  }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
  <link rel="stylesheet" href="../styles.css">
  <link rel="alternate" type="application/rss+xml" title="Humza Tareen Blog" href="https://humzakt.github.io/blog/feed.xml">
  <style>
    .blog-post { max-width: 800px; margin: 0 auto; padding: calc(var(--nav-height) + 40px) 24px 80px; }
    .blog-back { display: inline-flex; align-items: center; gap: 8px; color: var(--accent); font-family: var(--font-mono); font-size: 14px; margin-bottom: 32px; }
    .blog-back:hover { gap: 12px; }
    .blog-header { margin-bottom: 40px; }
    .blog-title { font-size: clamp(28px, 5vw, 42px); color: var(--heading); line-height: 1.2; margin-bottom: 16px; font-weight: 700; }
    .blog-meta { display: flex; flex-wrap: wrap; align-items: center; gap: 16px; color: var(--text); font-size: 14px; font-family: var(--font-mono); margin-bottom: 24px; }
    .blog-meta time { color: var(--accent); }
    .blog-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 24px; }
    .blog-tag { font-size: 12px; padding: 4px 12px; border-radius: 20px; background: rgba(100,255,218,0.08); color: var(--accent); font-family: var(--font-mono); }
    .blog-content { color: var(--text-light); line-height: 1.8; font-size: 17px; }
    .blog-content h2 { color: var(--heading); font-size: 24px; margin: 48px 0 16px; font-weight: 600; }
    .blog-content h3 { color: var(--heading); font-size: 20px; margin: 32px 0 12px; font-weight: 600; }
    .blog-content p { margin-bottom: 20px; }
    .blog-content ul, .blog-content ol { margin-bottom: 20px; padding-left: 24px; }
    .blog-content li { margin-bottom: 8px; }
    .blog-content strong { color: var(--heading); font-weight: 600; }
    .blog-content code { font-family: var(--font-mono); font-size: 0.9em; background: var(--bg-light); padding: 2px 6px; border-radius: 4px; color: var(--accent); }
    .blog-content pre { background: var(--bg-light); border: 1px solid var(--card-border); border-radius: 8px; padding: 20px; overflow-x: auto; margin-bottom: 24px; font-size: 14px; line-height: 1.6; }
    .blog-content pre code { background: none; padding: 0; color: var(--text-light); }
    .blog-content a { color: var(--accent); text-decoration: underline; text-underline-offset: 3px; }
    .blog-content a:hover { color: var(--heading); }
    .blog-content table { width: 100%; border-collapse: collapse; margin-bottom: 24px; font-size: 15px; }
    .blog-content th, .blog-content td { padding: 12px 16px; border: 1px solid var(--card-border); text-align: left; }
    .blog-content th { background: var(--bg-light); color: var(--heading); font-weight: 600; }
    .blog-footer { margin-top: 60px; padding-top: 32px; border-top: 1px solid var(--card-border); }
    .blog-author { display: flex; align-items: center; gap: 16px; }
    .blog-author-img { width: 56px; height: 56px; border-radius: 50%; object-fit: cover; }
    .blog-author-info h4 { color: var(--heading); font-size: 16px; }
    .blog-author-info p { color: var(--text); font-size: 14px; }
    .blog-cta { margin-top: 32px; text-align: center; }
    .blog-cta a { display: inline-block; padding: 12px 28px; border: 1px solid var(--accent); color: var(--accent); border-radius: 6px; font-family: var(--font-mono); font-size: 14px; transition: var(--transition); }
    .blog-cta a:hover { background: var(--accent-muted); }
    @media (max-width: 768px) { .blog-post { padding-top: calc(var(--nav-height) + 20px); } .blog-content { font-size: 16px; } }
  </style>
</head>
<body>
  <nav class="nav" id="nav" aria-label="Main navigation">
    <a href="../index.html" class="nav-logo" aria-label="Humza Tareen - Home">HT</a>
    <div class="nav-links" role="list">
      <div class="page-switcher"><a href="../engineering.html">Engineering</a><a href="../research.html">Research</a></div>
      <a href="../engineering.html#articles" role="listitem">All Articles</a>
      <a href="../engineering.html#contact" class="nav-cta" role="listitem">Hire Me</a>
    </div>
  </nav>
  <main class="blog-post">
    <a href="../engineering.html#articles" class="blog-back"><i class="fas fa-arrow-left"></i> All Articles</a>
    <article>
      <header class="blog-header">
        <h1 class="blog-title">Building a RAG Retrieval Service: pgvector, Embedding Migrations, and Provenance Tracking</h1>
        <div class="blog-meta"><time datetime="2026-02-08">Feb 8, 2026</time><span>&middot;</span><span>6 min read</span><span>&middot;</span><span>Humza Tareen</span></div>
        <div class="blog-tags">
          <span class="blog-tag">RAG</span><span class="blog-tag">pgvector</span><span class="blog-tag">Embeddings</span><span class="blog-tag">PostgreSQL</span><span class="blog-tag">FastAPI</span>
        </div>
      </header>
      <div class="blog-content">
        <p>In an AI evaluation platform, the ability to learn from past evaluations is what separates a useful tool from a demo. The RAG retrieval service provides that learning loop — when a new evaluation comes in, it can find similar past evaluations, their scores, and their outcomes. The secret ingredient: pgvector on PostgreSQL.</p>
        
        <h2>How the RAG Pipeline Works</h2>
        <p>The retrieval flow is elegant in its simplicity. When evaluation data arrives, it gets embedded using a configurable model (currently <code>text-embedding-3-large</code>). Those embeddings are stored in PostgreSQL with pgvector, creating a searchable vector space of all past evaluations.</p>
        <p>When new tasks arrive, the system finds similar past evaluations via cosine similarity. Those results inform scoring calibration and rubric selection — if a similar task scored poorly with one rubric, we might try a different approach. The magic happens in a single SQL query:</p>
        <pre><code>SELECT 
  evaluation_id,
  score,
  outcome,
  1 - (embedding <=> $1::vector) AS similarity
FROM evaluations
WHERE embedding <=> $1::vector < 0.3
ORDER BY embedding <=> $1::vector
LIMIT 10;</code></pre>
        <p>The <code><=></code> operator computes cosine distance, and pgvector's IVFFlat index makes this fast even with millions of evaluations.</p>
        
        <h2>The Midnight Deprecation Crisis</h2>
        <p>The embedding model <code>text-embedding-004</code> was deprecated overnight. Every query started returning 404. No warning, no grace period — just broken.</p>
        <p>We needed to make the model configurable via <code>EMBED_MODEL</code> and <code>EMBED_DIMENSIONS</code> environment variables, but we couldn't afford downtime. The migration strategy had three parts:</p>
        <p>First, we added side-by-side columns in the database — <code>embedding_v1</code> and <code>embedding_v2</code> — so we could roll back if the new model performed worse. Then we built a batch re-embedding pipeline that processed documents in chunks, updating <code>embedding_v2</code> while queries continued using <code>embedding_v1</code>.</p>
        <p>Finally, we added a feature flag to switch between columns. When we were confident the new embeddings worked, we flipped the flag. Zero downtime. The service now supports any embedding model via configuration — change the env var, re-embed, and switch.</p>
        
        <h2>Provenance Tracking for Calibration</h2>
        <p>CLI evaluation agents needed to know <em>where</em> data came from to calibrate their scoring. If a similar evaluation scored 0.8, was that from a production run or a test? Was it from the same agent model or a different one?</p>
        <p>I added <code>provenance</code> and <code>source_type</code> fields to the retrieval endpoint. The insight: optional return fields save bandwidth when you don't need lineage data, but they're critical for calibration workflows. The endpoint accepts a <code>include_provenance</code> query parameter — when false, we skip those columns entirely.</p>
        <p>This small change enabled downstream services to build calibration logic that learns from similar evaluations while respecting their context.</p>
        
        <h2>The Null Serialization Trap</h2>
        <p>The response included <code>"provenance": null</code> which broke downstream consumers expecting the field to be absent, not null. In microservice architectures, API contracts matter — a field that's <code>null</code> vs. a field that's missing sends different signals.</p>
        <p>The fix was simple but illustrative: <code>response_model_exclude_none=True</code> in the FastAPI endpoint. Now, when provenance isn't requested, the field doesn't appear in the JSON at all. When it is requested but missing, it's still <code>null</code>, but that's the expected case.</p>
        <p>This taught me that API design isn't just about what you include — it's about what you exclude, and how you signal absence vs. unavailability.</p>
        
        <h2>Infrastructure</h2>
        <p>The service runs on Cloud SQL PostgreSQL 17 with the pgvector extension. We use an IVFFlat index with cosine similarity, tuned with 100 lists for our dataset size. The index gets rebuilt daily via Cloud Scheduler to maintain query performance as new evaluations arrive.</p>
        <p>Deployment is straightforward: Cloud Run with autoscaling based on request volume. The embedding model runs via OpenAI's API (configurable to any compatible provider), and the service handles rate limiting and retries internally.</p>
      </div>
      <footer class="blog-footer">
        <div class="blog-author"><img src="../suit-blue-bg.jpg" alt="Humza Tareen" class="blog-author-img"><div class="blog-author-info"><h4>Humza Tareen</h4><p>AI Engineer building production systems at scale. <a href="../engineering.html">View full portfolio</a></p></div></div>
        <div class="blog-cta"><a href="../engineering.html#articles">Read More Articles</a></div>
      </footer>
    </article>
  </main>
</body>
</html>
