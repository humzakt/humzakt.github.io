<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Building an AI Evaluation Platform on GCP: Architecture of a Multi-Cluster System — Humza Tareen</title>
  <meta name="description" content="A deep dive into the architecture behind a production-grade AI agent evaluation system on GCP with multiple Cloud Run services, several GKE clusters, and managed databases.">
  <meta name="author" content="Humza Tareen">
  <meta name="keywords" content="GCP, Cloud Run, GKE, Kubernetes, Microservices, AI, Cloud Architecture, PostgreSQL, Pub/Sub, Cloud Tasks, Python, FastAPI">
  <link rel="canonical" href="https://humzakt.github.io/blog/building-ai-evaluation-platform-gcp.html">
  <!-- Open Graph -->
  <meta property="og:title" content="Building an AI Evaluation Platform on GCP: Architecture of a Multi-Cluster System">
  <meta property="og:description" content="A deep dive into the architecture behind a production-grade AI agent evaluation system on GCP.">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://humzakt.github.io/blog/building-ai-evaluation-platform-gcp.html">
  <meta property="og:image" content="https://humzakt.github.io/suit-blue-bg.jpg">
  <meta property="og:site_name" content="Humza Tareen">
  <meta property="article:published_time" content="2026-02-08T00:00:00Z">
  <meta property="article:author" content="Humza Tareen">
  <meta property="article:tag" content="GCP">
  <meta property="article:tag" content="Cloud Architecture">
  <meta property="article:tag" content="Kubernetes">
  <meta property="article:tag" content="Microservices">
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Building an AI Evaluation Platform on GCP">
  <meta name="twitter:description" content="Architecture deep dive into a production-grade AI evaluation platform on GCP.">
  <meta name="twitter:image" content="https://humzakt.github.io/suit-blue-bg.jpg">
  <!-- JSON-LD BlogPosting -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "Building an AI Evaluation Platform on GCP: Architecture of a Multi-Cluster System",
    "description": "A deep dive into the architecture behind a production-grade AI agent evaluation system on GCP.",
    "image": "https://humzakt.github.io/suit-blue-bg.jpg",
    "author": {
      "@type": "Person",
      "name": "Humza Tareen",
      "url": "https://humzakt.github.io"
    },
    "publisher": {
      "@type": "Person",
      "name": "Humza Tareen"
    },
    "datePublished": "2026-02-08",
    "dateModified": "2026-02-08",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://humzakt.github.io/blog/building-ai-evaluation-platform-gcp.html"
    },
    "keywords": ["GCP", "Cloud Run", "GKE", "Kubernetes", "Microservices", "AI", "PostgreSQL", "Pub/Sub", "Cloud Tasks", "Python", "FastAPI"],
    "wordCount": 2800,
    "articleSection": "Cloud Architecture"
  }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
  <link rel="stylesheet" href="../styles.css">
  <link rel="alternate" type="application/rss+xml" title="Humza Tareen Blog" href="https://humzakt.github.io/blog/feed.xml">
  <style>
    .blog-post { max-width: 800px; margin: 0 auto; padding: calc(var(--nav-height) + 40px) 24px 80px; }
    .blog-back { display: inline-flex; align-items: center; gap: 8px; color: var(--accent); font-family: var(--font-mono); font-size: 14px; margin-bottom: 32px; }
    .blog-back:hover { gap: 12px; }
    .blog-header { margin-bottom: 40px; }
    .blog-title { font-size: clamp(28px, 5vw, 42px); color: var(--heading); line-height: 1.2; margin-bottom: 16px; font-weight: 700; }
    .blog-meta { display: flex; flex-wrap: wrap; align-items: center; gap: 16px; color: var(--text); font-size: 14px; font-family: var(--font-mono); margin-bottom: 24px; }
    .blog-meta time { color: var(--accent); }
    .blog-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 24px; }
    .blog-tag { font-size: 12px; padding: 4px 12px; border-radius: 20px; background: rgba(100,255,218,0.08); color: var(--accent); font-family: var(--font-mono); }
    .blog-content { color: var(--text-light); line-height: 1.8; font-size: 17px; }
    .blog-content h2 { color: var(--heading); font-size: 24px; margin: 48px 0 16px; font-weight: 600; }
    .blog-content h3 { color: var(--heading); font-size: 20px; margin: 32px 0 12px; font-weight: 600; }
    .blog-content p { margin-bottom: 20px; }
    .blog-content ul, .blog-content ol { margin-bottom: 20px; padding-left: 24px; }
    .blog-content li { margin-bottom: 8px; }
    .blog-content strong { color: var(--heading); font-weight: 600; }
    .blog-content code { font-family: var(--font-mono); font-size: 0.9em; background: var(--bg-light); padding: 2px 6px; border-radius: 4px; color: var(--accent); }
    .blog-content pre { background: var(--bg-light); border: 1px solid var(--card-border); border-radius: 8px; padding: 20px; overflow-x: auto; margin-bottom: 24px; font-size: 14px; line-height: 1.6; }
    .blog-content pre code { background: none; padding: 0; color: var(--text-light); }
    .blog-content blockquote { border-left: 3px solid var(--accent); padding-left: 20px; margin: 24px 0; color: var(--text); font-style: italic; }
    .blog-content a { color: var(--accent); text-decoration: underline; text-underline-offset: 3px; }
    .blog-content a:hover { color: var(--heading); }
    .blog-content table { width: 100%; border-collapse: collapse; margin-bottom: 24px; font-size: 15px; }
    .blog-content th, .blog-content td { padding: 12px 16px; border: 1px solid var(--card-border); text-align: left; }
    .blog-content th { background: var(--bg-light); color: var(--heading); font-weight: 600; }
    .blog-footer { margin-top: 60px; padding-top: 32px; border-top: 1px solid var(--card-border); }
    .blog-author { display: flex; align-items: center; gap: 16px; }
    .blog-author-img { width: 56px; height: 56px; border-radius: 50%; object-fit: cover; }
    .blog-author-info h4 { color: var(--heading); font-size: 16px; }
    .blog-author-info p { color: var(--text); font-size: 14px; }
    .blog-cta { margin-top: 32px; text-align: center; }
    .blog-cta a { display: inline-block; padding: 12px 28px; border: 1px solid var(--accent); color: var(--accent); border-radius: 6px; font-family: var(--font-mono); font-size: 14px; transition: var(--transition); }
    .blog-cta a:hover { background: var(--accent-muted); }
    @media (max-width: 768px) { .blog-post { padding-top: calc(var(--nav-height) + 20px); } .blog-content { font-size: 16px; } }
  </style>
</head>
<body>

  <nav class="nav" id="nav" aria-label="Main navigation">
    <a href="../index.html" class="nav-logo" aria-label="Humza Tareen - Home">HT</a>
    <div class="nav-links" role="list">
      <div class="page-switcher">
        <a href="../engineering.html">Engineering</a>
        <a href="../research.html">Research</a>
      </div>
      <a href="../engineering.html#articles" role="listitem">All Articles</a>
      <a href="../engineering.html#contact" class="nav-cta" role="listitem">Hire Me</a>
    </div>
  </nav>

  <main class="blog-post">
    <a href="../engineering.html#articles" class="blog-back"><i class="fas fa-arrow-left"></i> All Articles</a>

    <article>
      <header class="blog-header">
        <h1 class="blog-title">Building an AI Evaluation Platform on GCP: Architecture of a Multi-Cluster System</h1>
        <div class="blog-meta">
          <time datetime="2026-02-08">Feb 8, 2026</time>
          <span>·</span>
          <span>10 min read</span>
          <span>·</span>
          <span>Humza Tareen</span>
        </div>
        <div class="blog-tags">
          <span class="blog-tag">GCP</span>
          <span class="blog-tag">Cloud Run</span>
          <span class="blog-tag">GKE</span>
          <span class="blog-tag">Pub/Sub</span>
          <span class="blog-tag">Cloud Tasks</span>
          <span class="blog-tag">PostgreSQL</span>
          <span class="blog-tag">Python</span>
          <span class="blog-tag">FastAPI</span>
        </div>
      </header>

      <div class="blog-content">
        <h2>The Problem</h2>
        <p>How do you evaluate whether an AI coding agent is actually good at writing code?</p>
        <p>Not with a single benchmark. Not with a leaderboard. You need a platform that can run thousands of evaluation tasks concurrently, execute untrusted code in sandboxed environments, judge outputs using multiple LLMs (GPT-4o, Claude Sonnet, Gemini), track agent performance over time with continuous learning, and scale to zero when idle.</p>
        <p>Over the past 6 months, I built this platform. This article is an honest look at the architecture, the decisions that worked, the ones that didn't, and the production incidents that taught me the most.</p>

        <h2>The Architecture</h2>
        <h3>Service Map</h3>
        <p>The platform consists of 10 core services, each deployed as a Cloud Run service with auto-scaling:</p>
        <p><strong>Core Evaluation Pipeline:</strong></p>
        <ul>
          <li><strong>Evaluation Engine</strong> — The brain. Manages task lifecycle, agent orchestration, and result aggregation.</li>
          <li><strong>Auto-Rating Service</strong> — Scores LLM outputs using configurable evaluation criteria. OpenAI-compatible API with LiteLLM proxy for model-agnostic scoring.</li>
          <li><strong>RAG Retrieval Service</strong> — Continuous learning from past evaluations using pgvector similarity search on PostgreSQL.</li>
        </ul>
        <p><strong>Execution &amp; Training:</strong></p>
        <ul>
          <li><strong>RL Training Arena</strong> — Gym-style reinforcement learning environment. Agents execute in Cloud Build sandboxes, earn rewards based on test results.</li>
          <li><strong>Preprocessor Service</strong> — 15-step task preparation pipeline. Analyzes repositories, generates verifiers, establishes baselines.</li>
        </ul>
        <p><strong>Platform Services:</strong></p>
        <ul>
          <li><strong>Guard Service</strong> — Authentication (Google OIDC, JWT, API keys), authorization, and API gateway with Kong integration.</li>
          <li><strong>Notification Service</strong> — Event-driven delivery with Cloud Tasks, exponential backoff, webhook dispatch.</li>
          <li><strong>Workflow Orchestration</strong> — HITL workflows with WebSocket support for real-time updates.</li>
        </ul>

        <h3>Infrastructure Layer</h3>
<pre><code>┌─────────────────────────────────────────────────┐
│          Cloud Run (multiple services)           │
│  Auto-scaling: 0-100 instances per service       │
│  Regions: us-central1, us-west1, asia-southeast1 │
├─────────────────────────────────────────────────┤
│       GKE (several clusters, auto-scaling)       │
│  - CLI Eval: n2-standard-8 + n2-highmem-4       │
│  - OSWorld: e2-medium + n2-standard-4            │
├─────────────────────────────────────────────────┤
│              Data Layer                           │
│  - Cloud SQL (PostgreSQL, Regional HA)           │
│  - Multiple Firestore databases                  │
│  - Redis (Memorystore) for caching               │
│  - pgvector for embedding similarity search      │
├─────────────────────────────────────────────────┤
│        Event &amp; Orchestration                     │
│  - Dozens of Pub/Sub topics (with DLQs)         │
│  - Cloud Tasks for reliable async execution      │
│  - Cloud Scheduler for daily automation          │
│  - GCS buckets for artifacts &amp; results          │
├─────────────────────────────────────────────────┤
│            Observability                          │
│  - Structured logging with correlation IDs       │
│  - Error rate alerts (&gt;5% threshold)             │
│  - Cloud Monitoring dashboards                   │
└─────────────────────────────────────────────────┘</code></pre>

        <h2>Decision 1: Cloud Run vs. GKE</h2>
        <p>We use both, and the split is deliberate:</p>
        <p><strong>Cloud Run</strong> for stateless request-response services (API gateway, rating, notifications). They scale to zero, bill per-request, and need zero Kubernetes knowledge to deploy.</p>
        <p><strong>GKE</strong> for long-running, stateful workloads (agent execution, RL training). These need persistent connections, GPU access, and fine-grained resource control.</p>
        <p>The mistake we almost made: putting everything on GKE because "it's more powerful." GKE is more powerful, but also more expensive when idle. Our notification service gets maybe 100 requests/hour off-peak. On GKE, that's a node running 24/7 for nothing.</p>

        <h2>Decision 2: AlloyDB + Firestore (Not Either/Or)</h2>
        <p>We use PostgreSQL (AlloyDB) for relational data — evaluation results, user data, task configurations. We use Firestore for real-time state — agent run progress, live dashboard updates, trajectory logging.</p>
        <p><strong>Why both?</strong> Evaluation results need ACID transactions, complex JOINs, and structured queries. Agent execution progress needs sub-second writes from multiple concurrent agents, real-time listeners for the frontend, and schema flexibility.</p>
        <p><strong>The gotcha:</strong> Firestore has a <code>(default)</code> database that catches everything if you're not careful. We had evaluation data routing to the default database instead of the tenant-specific one. Fix: explicit database references everywhere, never rely on defaults.</p>

        <h2>The Hardest Bug: AlloyDB SSL Connection Drops</h2>
        <p>This was the bug that taught me the most about cloud infrastructure.</p>
        <p><strong>Symptoms:</strong> Long-running evaluation tasks (15+ minutes) would fail with "SSL connection has been closed unexpectedly." Not every time — roughly 5% of tasks.</p>
        <p><strong>Root cause:</strong> AlloyDB terminates idle SSL connections. Our SQLAlchemy connection pool was set to recycle connections every 900 seconds (15 minutes). But AlloyDB was killing them at ~10 minutes of inactivity.</p>
        <p><strong>Fix:</strong></p>
<pre><code>engine = create_engine(
    DATABASE_URL,
    pool_recycle=180,      # Recycle before AlloyDB kills them
    pool_pre_ping=True,    # Validate connection on checkout
    pool_size=5,           # Don't hold more than you need
    max_overflow=10,       # Allow burst but not stampede
)</code></pre>
        <p>We went from ~5% random task failures to 0.01% after this change.</p>

        <h2>Idempotency: The Pattern That Saved Us</h2>
        <p>Cloud Tasks delivers messages at-least-once. That means your handler WILL be called multiple times for the same task. Our pattern: compute a deterministic ID from the task payload, use <code>INSERT ... ON CONFLICT DO NOTHING</code>, return success even if the row already exists.</p>
        <p>This one pattern eliminated an entire category of bugs across the platform.</p>

        <h2>What I'd Do Differently</h2>
        <p>Connection pooling from day one. Would have avoided the AlloyDB crisis entirely. We learned the hard way that managed databases have their own connection lifecycle, and if you don't configure your pool correctly, you'll hit SSL connection drops under load. Setting <code>pool_recycle</code> and <code>pool_pre_ping</code> from the start would have saved us weeks of debugging.</p>

        <p>Explicit database references everywhere. Would have prevented the Firestore trap. Firestore has a <code>(default)</code> database that catches everything if you're not careful. We had evaluation data routing to the default database instead of the tenant-specific one. The fix was simple—explicit database references everywhere, never rely on defaults—but we should have done it from the beginning.</p>

        <p>Security audit earlier, not after 6 months of shipping. We accumulated security debt silently. SQL injection vulnerabilities, hardcoded credentials, PII in logs—all things that would have been caught in a systematic audit. The two-day audit we did eventually uncovered critical vulnerabilities across the entire platform. Doing it at month 2 instead of month 6 would have saved us from potential production incidents.</p>

        <p>Event-driven first, REST as the exception. We retrofitted events onto some services that should have been event-driven from the start. The notification service started as a REST API, then we added Pub/Sub subscribers. The RAG service started synchronous, then we added async processing. Starting with events would have made the architecture cleaner and more scalable from day one.</p>

        <p><strong>Tech stack:</strong> Python (FastAPI, SQLAlchemy, Pydantic), TypeScript (React), GCP (Cloud Run, GKE, Cloud Tasks, Pub/Sub, AlloyDB, Firestore, Cloud Build, GCS, Cloud Scheduler, Secret Manager, Cloud Monitoring), PostgreSQL, Redis, Docker, GitHub Actions.</p>
      </div>

      <footer class="blog-footer">
        <div class="blog-author">
          <img src="../suit-blue-bg.jpg" alt="Humza Tareen" class="blog-author-img">
          <div class="blog-author-info">
            <h4>Humza Tareen</h4>
            <p>AI Engineer building production systems at scale. <a href="../engineering.html">View full portfolio</a></p>
          </div>
        </div>
        <div class="blog-cta">
          <a href="../engineering.html#articles">Read More Articles</a>
        </div>
      </footer>
    </article>
  </main>

</body>
</html>
