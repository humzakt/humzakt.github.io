<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zero-Downtime Embedding Migration: Switching Models in a Production RAG System — Humza Tareen</title>
  <meta name="description" content="Step-by-step guide for migrating embedding models in production using pgvector, with zero downtime and zero data loss.">
  <meta name="author" content="Humza Tareen">
  <meta name="keywords" content="RAG, Embeddings, pgvector, PostgreSQL, AI, Vector Search, Python, OpenAI">
  <link rel="canonical" href="https://humzakt.github.io/blog/rag-embedding-migration-zero-downtime.html">
  <link rel="author" href="https://humzakt.github.io/llms.txt" type="text/plain" title="LLMs.txt">
  <meta property="og:title" content="Zero-Downtime Embedding Migration: Switching Models in a Production RAG System">
  <meta property="og:description" content="Step-by-step guide for migrating embedding models in production using pgvector, with zero downtime and zero data loss.">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://humzakt.github.io/blog/rag-embedding-migration-zero-downtime.html">
  <meta property="og:image" content="https://humzakt.github.io/suit-blue-bg.jpg">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:site_name" content="Humza Tareen">
  <meta property="article:published_time" content="2026-02-08T00:00:00Z">
  <meta property="article:author" content="Humza Tareen">
  <meta property="article:tag" content="RAG">
  <meta property="article:tag" content="AI">
  <meta property="article:tag" content="Embeddings">
  <meta property="article:tag" content="PostgreSQL">
  <meta property="article:tag" content="Python">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Zero-Downtime Embedding Migration: Switching Models in a Production RAG System">
  <meta name="twitter:description" content="Step-by-step guide for migrating embedding models in production using pgvector, with zero downtime and zero data loss.">
  <meta name="twitter:image" content="https://humzakt.github.io/suit-blue-bg.jpg">
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "Zero-Downtime Embedding Migration: Switching Models in a Production RAG System",
    "description": "Step-by-step guide for migrating embedding models in production using pgvector, with zero downtime and zero data loss.",
    "image": "https://humzakt.github.io/suit-blue-bg.jpg",
    "author": { "@type": "Person", "name": "Humza Tareen", "url": "https://humzakt.github.io" },
    "publisher": { "@type": "Person", "name": "Humza Tareen" },
    "datePublished": "2026-02-08",
    "dateModified": "2026-02-08",
    "mainEntityOfPage": { "@type": "WebPage", "@id": "https://humzakt.github.io/blog/rag-embedding-migration-zero-downtime.html" },
    "keywords": ["RAG", "AI", "Embeddings", "PostgreSQL", "Python"],
    "articleSection": "AI/ML Infrastructure"
  }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
  <link rel="stylesheet" href="../styles.css">
  <link rel="alternate" type="application/rss+xml" title="Humza Tareen Blog" href="https://humzakt.github.io/blog/feed.xml">
  <style>
    .blog-post { max-width: 800px; margin: 0 auto; padding: calc(var(--nav-height) + 40px) 24px 80px; }
    .blog-back { display: inline-flex; align-items: center; gap: 8px; color: var(--accent); font-family: var(--font-mono); font-size: 14px; margin-bottom: 32px; }
    .blog-back:hover { gap: 12px; }
    .blog-header { margin-bottom: 40px; }
    .blog-title { font-size: clamp(28px, 5vw, 42px); color: var(--heading); line-height: 1.2; margin-bottom: 16px; font-weight: 700; }
    .blog-meta { display: flex; flex-wrap: wrap; align-items: center; gap: 16px; color: var(--text); font-size: 14px; font-family: var(--font-mono); margin-bottom: 24px; }
    .blog-meta time { color: var(--accent); }
    .blog-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 24px; }
    .blog-tag { font-size: 12px; padding: 4px 12px; border-radius: 20px; background: rgba(100,255,218,0.08); color: var(--accent); font-family: var(--font-mono); }
    .blog-content { color: var(--text-light); line-height: 1.8; font-size: 17px; }
    .blog-content h2 { color: var(--heading); font-size: 24px; margin: 48px 0 16px; font-weight: 600; }
    .blog-content h3 { color: var(--heading); font-size: 20px; margin: 32px 0 12px; font-weight: 600; }
    .blog-content p { margin-bottom: 20px; }
    .blog-content ul, .blog-content ol { margin-bottom: 20px; padding-left: 24px; }
    .blog-content li { margin-bottom: 8px; }
    .blog-content strong { color: var(--heading); font-weight: 600; }
    .blog-content code { font-family: var(--font-mono); font-size: 0.9em; background: var(--bg-light); padding: 2px 6px; border-radius: 4px; color: var(--accent); }
    .blog-content pre { background: var(--bg-light); border: 1px solid var(--card-border); border-radius: 8px; padding: 20px; overflow-x: auto; margin-bottom: 24px; font-size: 14px; line-height: 1.6; }
    .blog-content pre code { background: none; padding: 0; color: var(--text-light); }
    .blog-content a { color: var(--accent); text-decoration: underline; text-underline-offset: 3px; }
    .blog-content a:hover { color: var(--heading); }
    .blog-content table { width: 100%; border-collapse: collapse; margin-bottom: 24px; font-size: 15px; }
    .blog-content th, .blog-content td { padding: 12px 16px; border: 1px solid var(--card-border); text-align: left; }
    .blog-content th { background: var(--bg-light); color: var(--heading); font-weight: 600; }
    .blog-footer { margin-top: 60px; padding-top: 32px; border-top: 1px solid var(--card-border); }
    .blog-author { display: flex; align-items: center; gap: 16px; }
    .blog-author-img { width: 56px; height: 56px; border-radius: 50%; object-fit: cover; }
    .blog-author-info h4 { color: var(--heading); font-size: 16px; }
    .blog-author-info p { color: var(--text); font-size: 14px; }
    .blog-cta { margin-top: 32px; text-align: center; }
    .blog-cta a { display: inline-block; padding: 12px 28px; border: 1px solid var(--accent); color: var(--accent); border-radius: 6px; font-family: var(--font-mono); font-size: 14px; transition: var(--transition); }
    .blog-cta a:hover { background: var(--accent-muted); }
    @media (max-width: 768px) { .blog-post { padding-top: calc(var(--nav-height) + 20px); } .blog-content { font-size: 16px; } }
  </style>
</head>
<body>
  <nav class="nav" id="nav" aria-label="Main navigation">
    <a href="../index.html" class="nav-logo" aria-label="Humza Tareen - Home">HT</a>
    <div class="nav-links" role="list">
      <div class="page-switcher">
        <a href="../engineering.html">Engineering</a>
        <a href="../research.html">Research</a>
      </div>
      <a href="../engineering.html#articles" role="listitem">All Articles</a>
      <a href="../engineering.html#contact" class="nav-cta" role="listitem">Hire Me</a>
    </div>
  </nav>
  <main class="blog-post">
    <a href="../engineering.html#articles" class="blog-back"><i class="fas fa-arrow-left"></i> All Articles</a>
    <article>
      <header class="blog-header">
        <h1 class="blog-title">Zero-Downtime Embedding Migration: Switching Models in a Production RAG System</h1>
        <div class="blog-meta">
          <time datetime="2026-02-08">Feb 8, 2026</time>
          <span>&middot;</span>
          <span>7 min read</span>
          <span>&middot;</span>
          <span>Humza Tareen</span>
        </div>
        <div class="blog-tags">
          <span class="blog-tag">RAG</span>
          <span class="blog-tag">AI</span>
          <span class="blog-tag">Embeddings</span>
          <span class="blog-tag">PostgreSQL</span>
          <span class="blog-tag">Python</span>
        </div>
      </header>
      <div class="blog-content">
        
        <p>Our embedding model got deprecated overnight. Every RAG query in our AI evaluation platform started returning 404s. This wasn't just a feature—it was the entire platform's learning system going down. The RAG service powers continuous learning from past evaluations, similarity search for task recommendations, and context retrieval for agent prompts. We had 48 hours to migrate to a new model, re-embed all documents, and not break a single production workflow.</p>

        <h2>Step 1: Make the Model Configurable</h2>
        <p>Why environment variables matter: you ship the config change, not a code change. Two environment variables:</p>

<pre><code>EMBED_MODEL = os.getenv("EMBED_MODEL", "text-embedding-3-large")
EMBED_DIMENSIONS = int(os.getenv("EMBED_DIMENSIONS", "768"))</code></pre>

        <p>This is what makes the difference between a 2-day migration and a 2-week one. If the model name was hardcoded in 20 files, we'd need to change code, test, deploy, and hope nothing broke. With env vars, we change the config, deploy once, and flip the switch. The code doesn't care which model it's using—it just reads the config.</p>

        <h2>Step 2: Add New Columns (Don't Replace)</h2>
        <p>The <code>CONCURRENTLY</code> keyword is critical. Without it, PostgreSQL locks the table during index creation. With millions of documents, that lock could last hours—production reads would freeze. Here's what we ran:</p>

<pre><code>ALTER TABLE documents
ADD COLUMN embedding_v2 vector(768);

CREATE INDEX CONCURRENTLY idx_documents_embedding_v2
ON documents USING ivfflat (embedding_v2 vector_cosine_ops)
WITH (lists = 100);</code></pre>

        <p>What happens without <code>CONCURRENTLY</code>: table locks, production freeze, users see timeouts. With <code>CONCURRENTLY</code>: index builds in the background, production reads continue uninterrupted, zero downtime. The trade-off is that concurrent index creation takes longer and uses more resources, but it's worth it for production systems.</p>

        <h2>Step 3: Batch Re-embedding</h2>
        <p>Batch processing is essential. Don't embed one document at a time—that's slow and hits rate limits. Don't embed all documents in one giant transaction—that holds locks for too long. We processed in batches of 1000 documents. Batch size selection matters: too small and you're making too many API calls. Too large and you're holding database transactions too long. We settled on 1000 as the sweet spot.</p>

        <p>Rate limiting against the embedding API: we added exponential backoff when hitting rate limits. Progress tracking: we logged every 10,000 documents so we could monitor progress. Per-batch commits: each batch of 1000 documents was committed independently. If the process crashed at document 50,000, we didn't lose the first 49,000. We could resume from checkpoint 50,000.</p>

        <h2>Step 4: Feature Flag Switch</h2>
        <p>The feature flag pattern is what made zero-downtime possible. Deploy with <code>USE_V2_EMBEDDINGS=false</code>. The code checks the flag:</p>

<pre><code>def get_embedding_column():
    if os.getenv("USE_V2_EMBEDDINGS", "false").lower() == "true":
        return "embedding_v2"
    return "embedding"</code></pre>

        <p>Verify everything works with v1 still active. Flip to <code>true</code>. If anything breaks, flip back instantly. No code deployment needed—just change the environment variable. This pattern is what separates production-ready migrations from risky ones.</p>

        <h2>Step 5: Validation</h2>
        <p>We compared search results between old and new embeddings. Average overlap was 82%—different models produce different embeddings, but the top results were comparable. What 82% overlap means practically: for a given query, if the old model returned documents A, B, C, D, E as the top 5 results, the new model returned A, B, D, E, F. Four out of five results were the same. The fifth was different, but still relevant. This validation gave us confidence that the migration wouldn't break user workflows.</p>

        <h2>Lessons Learned</h2>
        <p><strong>Always abstract the embedding provider.</strong> Two env vars saved us from a multi-file refactor. If we had hardcoded the model name in 20 files, we'd need to change code, test each change, deploy, and hope nothing broke. With abstraction, we change config and flip a switch.</p>

        <p><strong>Add model version tracking to stored vectors.</strong> We didn't. We should have. If we had a <code>model_version</code> column, we could have queried "which documents were embedded with which model" and migrated selectively. Without it, we had to re-embed everything.</p>

        <p><strong>Side-by-side columns &gt; in-place replacement.</strong> The rollback story is instant. If v2 embeddings cause issues, flip the feature flag back to v1. The old embeddings are still there, still indexed, still usable. In-place replacement would have required restoring from backup.</p>

        <p><strong>Dry-run everything.</strong> Our validation caught 3 queries with low overlap that needed investigation. We ran the same queries against both embedding versions, compared results, and identified edge cases before flipping the switch. This proactive validation prevented production issues.</p>

        <p>Total impact: 48 hours, zero downtime, zero data loss. The entire platform's learning system migrated to a new embedding model without breaking a single production workflow. The key was planning for failure: feature flags for instant rollback, concurrent index creation for zero downtime, batch processing with checkpoints for resilience, and validation to catch issues before they reach production.</p>
        
      </div>
      <footer class="blog-footer">
        <div class="blog-author">
          <img src="../suit-blue-bg.jpg" alt="Humza Tareen" class="blog-author-img">
          <div class="blog-author-info">
            <h4>Humza Tareen</h4>
            <p>AI Engineer building production systems at scale. <a href="../engineering.html">View full portfolio</a></p>
          </div>
        </div>
        <div class="blog-cta">
          <a href="../engineering.html#articles">Read More Articles</a>
        </div>
      </footer>
    </article>
  </main>
</body>
</html>