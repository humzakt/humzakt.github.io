<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Building the Core AI Evaluation Engine: AlloyDB Fixes, Autoscaling, and a Headless API — Humza Tareen</title>
  <meta name="description" content="Deep dive into the core evaluation engine behind an AI agent assessment platform. Extensive contributions covering AlloyDB SSL fixes, KEDA autoscaling, Firestore misrouting, continuous learning, and a headless API.">
  <meta name="author" content="Humza Tareen">
  <meta name="keywords" content="AI Evaluation, Cloud Run, AlloyDB, GKE, KEDA, Firestore, Python, FastAPI, PostgreSQL">
  <link rel="canonical" href="https://humzakt.github.io/blog/atlas-evaluations-core-engine.html">
  <meta property="og:title" content="Building the Core AI Evaluation Engine: AlloyDB Fixes, Autoscaling, and a Headless API">
  <meta property="og:description" content="Deep dive into the core evaluation engine behind an AI agent assessment platform. Extensive engineering contributions over 4 months.">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://humzakt.github.io/blog/atlas-evaluations-core-engine.html">
  <meta property="og:image" content="https://humzakt.github.io/suit-blue-bg.jpg">
  <meta property="og:site_name" content="Humza Tareen">
  <meta property="article:published_time" content="2026-02-08T00:00:00Z">
  <meta property="article:author" content="Humza Tareen">
  <meta property="article:tag" content="Cloud Run">
  <meta property="article:tag" content="AlloyDB">
  <meta property="article:tag" content="GKE">
  <meta property="article:tag" content="KEDA">
  <meta property="article:tag" content="Firestore">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Building the Core AI Evaluation Engine: AlloyDB Fixes, Autoscaling, and a Headless API">
  <meta name="twitter:description" content="AlloyDB SSL fixes, KEDA autoscaling, Firestore misrouting, continuous learning, and a headless API.">
  <meta name="twitter:image" content="https://humzakt.github.io/suit-blue-bg.jpg">
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "Building the Core AI Evaluation Engine: AlloyDB Fixes, Autoscaling, and a Headless API",
    "description": "Deep dive into the core evaluation engine behind an AI agent assessment platform.",
    "image": "https://humzakt.github.io/suit-blue-bg.jpg",
    "author": { "@type": "Person", "name": "Humza Tareen", "url": "https://humzakt.github.io" },
    "publisher": { "@type": "Person", "name": "Humza Tareen" },
    "datePublished": "2026-02-08",
    "dateModified": "2026-02-08",
    "mainEntityOfPage": { "@type": "WebPage", "@id": "https://humzakt.github.io/blog/atlas-evaluations-core-engine.html" },
    "keywords": ["Cloud Run", "AlloyDB", "GKE", "KEDA", "Firestore", "Python", "FastAPI"],
    "articleSection": "Cloud Architecture"
  }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
  <link rel="stylesheet" href="../styles.css">
  <link rel="alternate" type="application/rss+xml" title="Humza Tareen Blog" href="https://humzakt.github.io/blog/feed.xml">
  <style>
    .blog-post { max-width: 800px; margin: 0 auto; padding: calc(var(--nav-height) + 40px) 24px 80px; }
    .blog-back { display: inline-flex; align-items: center; gap: 8px; color: var(--accent); font-family: var(--font-mono); font-size: 14px; margin-bottom: 32px; }
    .blog-back:hover { gap: 12px; }
    .blog-header { margin-bottom: 40px; }
    .blog-title { font-size: clamp(28px, 5vw, 42px); color: var(--heading); line-height: 1.2; margin-bottom: 16px; font-weight: 700; }
    .blog-meta { display: flex; flex-wrap: wrap; align-items: center; gap: 16px; color: var(--text); font-size: 14px; font-family: var(--font-mono); margin-bottom: 24px; }
    .blog-meta time { color: var(--accent); }
    .blog-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 24px; }
    .blog-tag { font-size: 12px; padding: 4px 12px; border-radius: 20px; background: rgba(100,255,218,0.08); color: var(--accent); font-family: var(--font-mono); }
    .blog-content { color: var(--text-light); line-height: 1.8; font-size: 17px; }
    .blog-content h2 { color: var(--heading); font-size: 24px; margin: 48px 0 16px; font-weight: 600; }
    .blog-content h3 { color: var(--heading); font-size: 20px; margin: 32px 0 12px; font-weight: 600; }
    .blog-content p { margin-bottom: 20px; }
    .blog-content ul, .blog-content ol { margin-bottom: 20px; padding-left: 24px; }
    .blog-content li { margin-bottom: 8px; }
    .blog-content strong { color: var(--heading); font-weight: 600; }
    .blog-content code { font-family: var(--font-mono); font-size: 0.9em; background: var(--bg-light); padding: 2px 6px; border-radius: 4px; color: var(--accent); }
    .blog-content pre { background: var(--bg-light); border: 1px solid var(--card-border); border-radius: 8px; padding: 20px; overflow-x: auto; margin-bottom: 24px; font-size: 14px; line-height: 1.6; }
    .blog-content pre code { background: none; padding: 0; color: var(--text-light); }
    .blog-content a { color: var(--accent); text-decoration: underline; text-underline-offset: 3px; }
    .blog-content a:hover { color: var(--heading); }
    .blog-content table { width: 100%; border-collapse: collapse; margin-bottom: 24px; font-size: 15px; }
    .blog-content th, .blog-content td { padding: 12px 16px; border: 1px solid var(--card-border); text-align: left; }
    .blog-content th { background: var(--bg-light); color: var(--heading); font-weight: 600; }
    .blog-footer { margin-top: 60px; padding-top: 32px; border-top: 1px solid var(--card-border); }
    .blog-author { display: flex; align-items: center; gap: 16px; }
    .blog-author-img { width: 56px; height: 56px; border-radius: 50%; object-fit: cover; }
    .blog-author-info h4 { color: var(--heading); font-size: 16px; }
    .blog-author-info p { color: var(--text); font-size: 14px; }
    .blog-cta { margin-top: 32px; text-align: center; }
    .blog-cta a { display: inline-block; padding: 12px 28px; border: 1px solid var(--accent); color: var(--accent); border-radius: 6px; font-family: var(--font-mono); font-size: 14px; transition: var(--transition); }
    .blog-cta a:hover { background: var(--accent-muted); }
    @media (max-width: 768px) { .blog-post { padding-top: calc(var(--nav-height) + 20px); } .blog-content { font-size: 16px; } }
  </style>
</head>
<body>
  <nav class="nav" id="nav" aria-label="Main navigation">
    <a href="../index.html" class="nav-logo" aria-label="Humza Tareen - Home">HT</a>
    <div class="nav-links" role="list">
      <div class="page-switcher"><a href="../engineering.html">Engineering</a><a href="../research.html">Research</a></div>
      <a href="../engineering.html#articles" role="listitem">All Articles</a>
      <a href="../engineering.html#contact" class="nav-cta" role="listitem">Hire Me</a>
    </div>
  </nav>
  <main class="blog-post">
    <a href="../engineering.html#articles" class="blog-back"><i class="fas fa-arrow-left"></i> All Articles</a>
    <article>
      <header class="blog-header">
        <h1 class="blog-title">Building the Core AI Evaluation Engine: AlloyDB Fixes, Autoscaling, and a Headless API</h1>
        <div class="blog-meta"><time datetime="2026-02-08">Feb 8, 2026</time><span>&middot;</span><span>12 min read</span><span>&middot;</span><span>Humza Tareen</span></div>
        <div class="blog-tags">
          <span class="blog-tag">Cloud Run</span><span class="blog-tag">AlloyDB</span><span class="blog-tag">GKE</span><span class="blog-tag">KEDA</span><span class="blog-tag">Firestore</span><span class="blog-tag">Python</span><span class="blog-tag">FastAPI</span>
        </div>
      </header>
      <div class="blog-content">
        <p>The evaluation engine is the brain of the platform. Every AI agent evaluation — task creation, execution orchestration, LLM-based scoring, result aggregation — flows through this service. Over four months, I was the primary contributor, and the work taught me more about production infrastructure than any textbook could.</p>
        
        <h2>The Architecture</h2>
<pre><code>┌──────────────────────────────────────────────────┐
│           Evaluation Engine (Cloud Run)           │
│  FastAPI + SQLAlchemy + Pydantic                  │
├──────────────────────────────────────────────────┤
│  Agent Plane (GKE)  │  Judge Pipeline (Cloud Run) │
│  Claude, GPT, Gemini │  Multi-LLM scoring         │
├──────────────────────────────────────────────────┤
│  AlloyDB (PostgreSQL 17)  │  Firestore (realtime) │
│  Cloud Tasks              │  Pub/Sub               │
│  Cloud Scheduler          │  GCS buckets          │
└──────────────────────────────────────────────────┘</code></pre>
        
        <h2>The AlloyDB SSL Crisis</h2>
        <p>This was a detective story. Our evaluation tasks — which run 5-30 minutes — were randomly failing at a 5% rate with <code>SSL connection has been closed unexpectedly</code>. The failures were intermittent, making them hard to reproduce.</p>
        <p>First, we added retries. Symptom treatment — it helped, but didn't fix the root cause. Then we suppressed errors on session close to see the real signal. During database pool alignment work, we discovered a Firestore bug (scores writing to the wrong database), but that was a separate issue.</p>
        <p>We implemented targeted retries for transient SSL disconnects, hardened sessions, and added better logging. The breakthrough came when we discovered the timing mismatch: AlloyDB kills idle connections at ~10 minutes, but SQLAlchemy's connection pool recycled at 15 minutes. That 5-minute window meant stale connections were being handed out.</p>
        <p>The fix was three lines of config:</p>
        <pre><code># Before
engine = create_engine(
    DATABASE_URL,
    pool_size=10
)

# After
engine = create_engine(
    DATABASE_URL,
    pool_size=10,
    pool_recycle=180,  # Recycle before AlloyDB kills (10 min = 600s, use 180s)
    pool_pre_ping=True  # Verify connection before use
)</code></pre>
        <p>Result: 5% failure rate → 0.01%. Multiple iterations over 2 weeks to understand one infrastructure quirk.</p>
        
        <h2>The Firestore Default Database Trap</h2>
        <p>Firestore has a <code>(default)</code> database that silently catches everything you don't explicitly route elsewhere. We had multiple databases for different services, but several code paths were writing to <code>(default)</code> without anyone realizing.</p>
        <p>The fix required updating every Firestore reference across backend and frontend. Here's the difference:</p>
        <pre><code># Implicit - goes to (default)
db = firestore.Client()
collection = db.collection('scores')

# Explicit - goes to correct database
db = firestore.Client(database='evaluations-db')
collection = db.collection('scores')</code></pre>
        <p>This was also extended to the React frontend — real-time listeners were using the wrong database, causing stale UI data. The lesson: explicit is better than implicit, especially in distributed systems.</p>
        
        <h2>Continuous Learning Pipeline</h2>
        <p>Connecting evaluation results back to the RAG service so future evaluations can learn from past outcomes. The gap was that scored evaluations weren't flowing back to pgvector for similarity search.</p>
        <p>When an evaluation completes, it now gets embedded and stored in the RAG service. Future evaluations can query "show me similar tasks and how they scored" to inform rubric selection and calibration. This closes the learning loop — the platform gets smarter with each evaluation.</p>
        
        <h2>The Headless API</h2>
        <p>Why it matters: external teams can now trigger evaluations as part of their CI/CD pipelines. Decoupling evaluation from the web UI opened up integration possibilities.</p>
        <p>Before, evaluations were UI-only. Now, any service can POST to <code>/api/v1/evaluations</code> with a task definition and get back evaluation results. Teams integrate agent evaluation into their release process — run evaluations on every commit, gate deployments on score thresholds, track performance over time.</p>
        <p>The headless API transformed the platform from a tool into a platform.</p>
        
        <h2>KEDA Autoscaling on GKE</h2>
        <p>Scale agent execution pods based on Pub/Sub message backlog. The gotcha: <code>idleReplicaCount</code> was misconfigured preventing scale-to-zero, and warm replicas weren't being maintained.</p>
        <p>After fixing the KEDA ScaledObject configuration, the cluster properly scales from zero to dozens of nodes based on queue depth. When evaluations queue up, pods spin up. When the queue empties, pods scale down to zero, saving costs.</p>
        <p>Autoscaling sounds simple until you realize it's balancing latency (warm replicas) vs. cost (scale-to-zero). The configuration is a compromise between these forces.</p>
        
        <h2>Security Audit Findings</h2>
        <p>Critical findings: Firestore rules allowing unauthenticated access, production Kubernetes using <code>:latest</code> tags, excessive TypeScript <code>any</code> usage, conflicting HPA and KEDA autoscaling.</p>
        <p>The Firestore rules were the most concerning — anyone could read or write evaluation data. We locked down rules to require authentication and proper IAM roles. The <code>:latest</code> tags meant deployments weren't reproducible — we moved to semantic versioning.</p>
        <p>The conflicting autoscaling was subtle: both HPA and KEDA were trying to scale the same pods, causing thrashing. We disabled HPA and let KEDA handle it.</p>
      </div>
      <footer class="blog-footer">
        <div class="blog-author"><img src="../suit-blue-bg.jpg" alt="Humza Tareen" class="blog-author-img"><div class="blog-author-info"><h4>Humza Tareen</h4><p>AI Engineer building production systems at scale. <a href="../engineering.html">View full portfolio</a></p></div></div>
        <div class="blog-cta"><a href="../engineering.html#articles">Read More Articles</a></div>
      </footer>
    </article>
  </main>
</body>
</html>
